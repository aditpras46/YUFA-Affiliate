<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio Link Pro - Cloud Database</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        /* Gaya Kotak Link */
        .style-rough { clip-path: polygon(0% 12%, 1% 2%, 99% 4%, 100% 15%, 98% 85%, 99% 98%, 2% 100%, 0% 90%); }
        .style-grunge { clip-path: polygon(2% 10%, 15% 3%, 35% 8%, 55% 2%, 75% 9%, 98% 1%, 100% 45%, 97% 95%, 80% 90%, 50% 98%, 20% 92%, 1% 100%, 0% 50%); }
        .style-metallic { clip-path: polygon(8% 0%, 100% 0%, 92% 100%, 0% 100%); }
        .style-layered { clip-path: polygon(10% 0%, 100% 0%, 100% 85%, 90% 100%, 0% 100%, 0% 15%); }
        
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-[#B5AD9E]">

    <div id="app">
        <div class="flex flex-col items-center justify-center min-h-screen bg-[#0E0B31] text-white">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-12 w-12 mb-4"></div>
            <p class="animate-pulse text-sm text-blue-400">Menghubungkan ke Cloud Spreadsheet...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Konfigurasi
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bio-link-spreadsheet-v1';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let state = {
            currentPage: 'bio', 
            activeTab: 'panel',
            currentUser: null, // Username yang sedang login
            allAccounts: [], // Data seluruh user untuk 'Spreadsheet View'
            links: [],
            settings: {
                namaToko: 'Guest User',
                deskripsi: 'Selamat datang di Bio Link',
                fotoProfil: '',
                fotoBackground: '',
                warnaBg: '#B5AD9E',
                warnaTulisan: '#F5F5F5',
                linkStyle: 'rough',
                customStyleUrl: '',
                socialLinks: { ig: '', fb: '', tiktok: '', shopee: '' }
            }
        };

        // --- Core Logic ---

        async function init() {
            // RULE 3: Auth dulu
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Subscribe ke seluruh akun untuk tampilan spreadsheet di dashboard
                    subscribeToAllAccounts();
                }
                render();
            });
        }

        // Ambil semua data registrasi (Spreadsheet View)
        function subscribeToAllAccounts() {
            const accountsRef = collection(db, 'artifacts', appId, 'public', 'data', 'accounts');
            onSnapshot(accountsRef, (snapshot) => {
                state.allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Jika sedang login, sinkronkan data profil dari akun spesifik
                if (state.currentUser) {
                    const myAccount = state.allAccounts.find(acc => acc.id === state.currentUser);
                    if (myAccount) {
                        state.settings = myAccount.settings || state.settings;
                        state.links = myAccount.links || [];
                        if (state.currentPage === 'bio') document.body.style.backgroundColor = state.settings.warnaBg;
                    }
                }
                render();
            }, (err) => console.error("Sync Error:", err));
        }

        async function saveToCloud() {
            if (!state.currentUser) return;
            const accountDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', state.currentUser);
            await setDoc(accountDocRef, {
                settings: state.settings,
                links: state.links,
                lastUpdated: new Date().toISOString()
            }, { merge: true });
        }

        // --- View Handlers ---

        window.navigate = (page) => {
            state.currentPage = page;
            if (page === 'bio') {
                document.body.style.backgroundColor = state.settings.warnaBg;
            } else {
                document.body.style.backgroundColor = '#0E0B31';
            }
            render();
        };

        window.setTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const namaToko = e.target.namaToko.value;

            const accountDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
            const check = await getDoc(accountDocRef);
            
            if (check.exists()) {
                alert('Username sudah terdaftar!');
                return;
            }

            await setDoc(accountDocRef, {
                username,
                password,
                createdAt: new Date().toISOString(),
                settings: { ...state.settings, namaToko },
                links: []
            });

            alert('Berhasil mendaftar! Data tersimpan di Cloud.');
            navigate('login');
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;

            const accountDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
            const snap = await getDoc(accountDocRef);

            if (snap.exists() && snap.data().password === password) {
                state.currentUser = username;
                state.settings = snap.data().settings || state.settings;
                state.links = snap.data().links || [];
                navigate('dashboard');
            } else {
                alert('Username atau Password salah!');
            }
        };

        window.addLink = () => {
            const name = document.getElementById('new-link-name').value;
            const url = document.getElementById('new-link-url').value;
            if (!name || !url) return;
            state.links.push({ id: Date.now(), name, url });
            saveToCloud();
        };

        window.deleteLink = (id) => {
            state.links = state.links.filter(l => l.id !== id);
            saveToCloud();
        };

        window.updateSetting = (key, value) => {
            state.settings[key] = value;
            saveToCloud();
        };

        window.updateSocial = (key, value) => {
            state.settings.socialLinks[key] = value;
            saveToCloud();
        };

        // --- Render UI ---

        function render() {
            const root = document.getElementById('app');
            if (state.currentPage === 'bio') root.innerHTML = renderBio();
            else if (state.currentPage === 'login') root.innerHTML = renderLogin();
            else if (state.currentPage === 'register') root.innerHTML = renderRegister();
            else if (state.currentPage === 'dashboard') root.innerHTML = renderDashboard();
            lucide.createIcons();
        }

        function renderBio() {
            const { settings, links } = state;
            const socialIcons = Object.entries(settings.socialLinks)
                .filter(([_, url]) => url)
                .map(([key, url]) => `
                    <a href="${url}" target="_blank" class="hover:scale-125 transition-all opacity-80 hover:opacity-100 p-2">
                        <i data-lucide="${key === 'ig' ? 'instagram' : key === 'fb' ? 'facebook' : key === 'tiktok' ? 'music-2' : 'shopping-bag'}" style="color: ${settings.warnaTulisan}"></i>
                    </a>
                `).join('');

            const linksHtml = links.map(link => {
                let styleAttr = `background-color: #2D281D; color: white;`;
                let classList = `block w-full py-4 px-6 text-center font-bold tracking-widest transition-all hover:scale-[1.02] shadow-lg`;
                if (settings.linkStyle === 'rough') classList += ' style-rough';
                if (settings.linkStyle === 'grunge') classList += ' style-grunge';
                if (settings.linkStyle === 'metallic') { classList += ' style-metallic'; styleAttr = `background-color: #DC2626;`; }
                if (settings.linkStyle === 'layered') { classList += ' style-layered'; styleAttr = `background-color: #FF9F1C;`; }
                if (settings.linkStyle === 'custom' && settings.customStyleUrl) {
                    styleAttr += ` -webkit-mask-image: url(${settings.customStyleUrl}); mask-image: url(${settings.customStyleUrl}); -webkit-mask-size: 100% 100%; mask-size: 100% 100%; background-color: #2D281D;`;
                }
                if (settings.linkStyle === 'rounded') classList += ' rounded-full';
                if (settings.linkStyle === 'soft') classList += ' rounded-xl';
                return `<a href="${link.url}" target="_blank" class="${classList}" style="${styleAttr}">${link.name}</a>`;
            }).join('');

            return `
                <div class="flex flex-col items-center min-h-screen py-12 px-6 relative overflow-hidden">
                    ${settings.fotoBackground ? `<img src="${settings.fotoBackground}" class="absolute inset-0 w-full h-full object-cover opacity-50 z-0">` : ''}
                    <div class="w-full max-w-md relative z-10 flex flex-col items-center">
                        <button onclick="navigate('login')" class="absolute top-0 right-0 p-2 rounded-full bg-black/10 hover:bg-black/20 transition-all">
                            <i data-lucide="log-in" style="color: ${settings.warnaTulisan}"></i>
                        </button>
                        <div class="mb-12 flex flex-col items-center text-center">
                            <div class="w-24 h-24 rounded-full border-4 border-white/20 overflow-hidden mb-4 shadow-xl bg-gray-200 flex items-center justify-center">
                                ${settings.fotoProfil ? `<img src="${settings.fotoProfil}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="text-gray-400"></i>`}
                            </div>
                            <h1 class="text-2xl font-bold tracking-wide" style="color: ${settings.warnaTulisan}">${settings.namaToko}</h1>
                            <p class="mt-1 italic opacity-80" style="color: ${settings.warnaTulisan}">${settings.deskripsi}</p>
                        </div>
                        <div class="w-full space-y-8 mb-10">${linksHtml || `<p class="opacity-20 italic">Belum ada link</p>`}</div>
                        <div class="flex flex-wrap justify-center gap-6">${socialIcons}</div>
                    </div>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen px-6 bg-[#0E0B31] text-white">
                    <div class="w-full max-w-md">
                        <button onclick="navigate('bio')" class="flex items-center gap-2 text-white/50 hover:text-white mb-8 font-bold"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div class="bg-gradient-to-br from-[#1A1A40] to-[#100A31] p-10 rounded-3xl shadow-2xl border border-white/5">
                            <h2 class="text-3xl font-bold text-center mb-10">Spreadsheet Login</h2>
                            <form onsubmit="handleLogin(event)" class="space-y-6">
                                <input name="username" type="text" placeholder="Username" class="w-full bg-[#0E0B31] border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500" required>
                                <input name="password" type="password" placeholder="Password" class="w-full bg-[#0E0B31] border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500" required>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest transition-all">Masuk Akun</button>
                            </form>
                            <div class="mt-8 text-center pt-6 border-t border-white/5">
                                <button onclick="navigate('register')" class="text-sm text-blue-400 font-bold hover:underline">Daftar Akun Baru</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRegister() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen px-6 bg-[#0E0B31] text-white">
                    <div class="w-full max-w-md">
                        <button onclick="navigate('login')" class="flex items-center gap-2 text-white/50 hover:text-white mb-8 font-bold"><i data-lucide="arrow-left"></i> Kembali</button>
                        <div class="bg-gradient-to-br from-[#1A1A40] to-[#100A31] p-10 rounded-3xl shadow-2xl border border-white/5">
                            <h2 class="text-3xl font-bold text-center mb-10">Registrasi Akun</h2>
                            <form onsubmit="handleRegister(event)" class="space-y-4">
                                <input name="username" type="text" placeholder="Username" class="w-full bg-[#0E0B31] border border-white/10 rounded-xl p-3 outline-none focus:border-blue-500" required>
                                <input name="namaToko" type="text" placeholder="Nama Toko / Judul Bio" class="w-full bg-[#0E0B31] border border-white/10 rounded-xl p-3 outline-none focus:border-blue-500" required>
                                <input name="password" type="password" placeholder="Password" class="w-full bg-[#0E0B31] border border-white/10 rounded-xl p-3 outline-none focus:border-blue-500" required>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg uppercase transition-all mt-4">Buat Akun & Simpan</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const { settings, links, activeTab, allAccounts } = state;
            let content = '';

            if (activeTab === 'panel') {
                content = `
                    <h1 class="text-4xl font-light mb-10">Panel Link</h1>
                    <div class="flex items-end gap-6 mb-16 p-8 bg-white/5 rounded-2xl border border-white/5 shadow-xl">
                        <div class="flex-1">
                            <label class="block text-[10px] uppercase text-white/40 mb-3 font-bold">Nama Link</label>
                            <input id="new-link-name" type="text" placeholder="Contoh: Shopee Store" class="w-full bg-[#1A1A40] border border-white/10 rounded-lg p-4 outline-none text-white">
                        </div>
                        <div class="flex-1">
                            <label class="block text-[10px] uppercase text-white/40 mb-3 font-bold">URL / Link</label>
                            <input id="new-link-url" type="text" placeholder="https://..." class="w-full bg-[#1A1A40] border border-white/10 rounded-lg p-4 outline-none text-white">
                        </div>
                        <button onclick="addLink()" class="bg-blue-600 text-white rounded-lg p-[18px] hover:bg-blue-500 shadow-lg"><i data-lucide="plus"></i></button>
                    </div>
                    <div class="space-y-4">
                        ${links.map((link, i) => `
                            <div class="flex items-center justify-between border border-white/10 bg-white/5 rounded-2xl p-6 group">
                                <div class="flex items-center gap-6">
                                    <span class="text-2xl font-light text-white/10">${i + 1}</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-white">${link.name}</h4>
                                        <p class="text-sm text-blue-400 font-mono italic opacity-70">${link.url}</p>
                                    </div>
                                </div>
                                <button onclick="deleteLink(${link.id})" class="p-3 text-white/20 hover:text-red-400"><i data-lucide="trash-2"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (activeTab === 'spreadsheet') {
                content = `
                    <h1 class="text-4xl font-light mb-10">Database View (Spreadsheet)</h1>
                    <div class="glass rounded-2xl overflow-hidden shadow-2xl">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white/5 text-white/60 uppercase text-[10px] font-black">
                                <tr>
                                    <th class="px-6 py-4">Username</th>
                                    <th class="px-6 py-4">Nama Toko</th>
                                    <th class="px-6 py-4">Daftar Link</th>
                                    <th class="px-6 py-4">Terakhir Update</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                ${allAccounts.map(acc => `
                                    <tr class="hover:bg-white/5 transition-colors">
                                        <td class="px-6 py-4 font-bold text-blue-400">${acc.username}</td>
                                        <td class="px-6 py-4 text-white/80">${acc.settings?.namaToko || '-'}</td>
                                        <td class="px-6 py-4 text-white/40">${acc.links?.length || 0} Link Aktif</td>
                                        <td class="px-6 py-4 text-[10px] font-mono opacity-30">${acc.lastUpdated || acc.createdAt || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="mt-6 text-white/20 text-xs italic">*Data ini disinkronkan secara real-time dari Cloud Database.</p>
                `;
            } else if (activeTab === 'settings') {
                content = `
                    <h1 class="text-4xl font-light mb-10">Pengaturan</h1>
                    <div class="space-y-10">
                        <div class="grid grid-cols-2 gap-8 bg-white/5 p-8 rounded-2xl border border-white/5">
                            <div class="space-y-4">
                                <label class="block text-[10px] font-bold text-white/40 uppercase">Judul Bio</label>
                                <input type="text" value="${settings.namaToko}" onchange="updateSetting('namaToko', this.value)" class="w-full bg-[#1A1A40] border border-white/10 rounded-lg p-3 text-white">
                                <label class="block text-[10px] font-bold text-white/40 uppercase">Deskripsi</label>
                                <input type="text" value="${settings.deskripsi}" onchange="updateSetting('deskripsi', this.value)" class="w-full bg-[#1A1A40] border border-white/10 rounded-lg p-3 text-white">
                            </div>
                            <div class="space-y-4">
                                <label class="block text-[10px] font-bold text-white/40 uppercase">URL Foto Profil</label>
                                <input type="text" value="${settings.fotoProfil}" onchange="updateSetting('fotoProfil', this.value)" class="w-full bg-[#1A1A40] border border-white/10 rounded-lg p-3 text-white">
                                <label class="block text-[10px] font-bold text-white/40 uppercase">Warna BG</label>
                                <input type="color" value="${settings.warnaBg}" onchange="updateSetting('warnaBg', this.value)" class="w-full h-10 bg-transparent border-none cursor-pointer rounded">
                            </div>
                        </div>
                        <div class="bg-white/5 p-8 rounded-2xl border border-white/5">
                            <label class="block text-[10px] font-bold text-white/40 uppercase mb-4">Sosial Media</label>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" placeholder="Instagram URL" value="${settings.socialLinks.ig}" onchange="updateSocial('ig', this.value)" class="bg-[#1A1A40] border border-white/10 rounded p-3 text-sm text-white">
                                <input type="text" placeholder="TikTok URL" value="${settings.socialLinks.tiktok}" onchange="updateSocial('tiktok', this.value)" class="bg-[#1A1A40] border border-white/10 rounded p-3 text-sm text-white">
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex min-h-screen bg-[#0E0B31] text-white overflow-hidden">
                    <!-- Sidebar -->
                    <div class="w-72 bg-gradient-to-b from-[#3D4DA0] to-[#606FC0] flex flex-col py-10 shadow-2xl z-20">
                        <div class="flex flex-col items-center mb-12 px-6 text-center">
                            <div class="w-24 h-24 rounded-full border-4 border-white mb-4 object-cover shadow-lg overflow-hidden bg-white/10 flex items-center justify-center">
                                ${settings.fotoProfil ? `<img src="${settings.fotoProfil}" class="w-full h-full object-cover">` : `<i data-lucide="user" class="text-white/30"></i>`}
                            </div>
                            <h3 class="font-bold text-2xl truncate w-full px-2">${settings.namaToko}</h3>
                            <p class="text-[10px] text-white/50 uppercase tracking-widest mt-1 truncate w-full px-4">${state.currentUser}</p>
                        </div>
                        <nav class="flex-1 px-4 space-y-1">
                            <div onclick="setTab('panel')" class="flex items-center gap-4 px-8 py-4 cursor-pointer relative ${activeTab === 'panel' ? 'bg-white/10 font-bold' : 'text-white/50'} transition-all">
                                ${activeTab === 'panel' ? '<div class="absolute left-0 top-0 bottom-0 w-1.5 bg-white"></div>' : ''}
                                <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
                            </div>
                            <div onclick="setTab('spreadsheet')" class="flex items-center gap-4 px-8 py-4 cursor-pointer relative ${activeTab === 'spreadsheet' ? 'bg-white/10 font-bold' : 'text-white/50'} transition-all">
                                ${activeTab === 'spreadsheet' ? '<div class="absolute left-0 top-0 bottom-0 w-1.5 bg-white"></div>' : ''}
                                <i data-lucide="table"></i><span>Data Log</span>
                            </div>
                            <div onclick="setTab('settings')" class="flex items-center gap-4 px-8 py-4 cursor-pointer relative ${activeTab === 'settings' ? 'bg-white/10 font-bold' : 'text-white/50'} transition-all">
                                ${activeTab === 'settings' ? '<div class="absolute left-0 top-0 bottom-0 w-1.5 bg-white"></div>' : ''}
                                <i data-lucide="settings"></i><span>Pengaturan</span>
                            </div>
                        </nav>
                        <div class="px-8 py-4 flex items-center gap-2 text-[10px] text-blue-200/40 italic"><i data-lucide="cloud" size="12"></i> Cloud Spreadsheet Active</div>
                        <button onclick="navigate('bio')" class="mt-auto flex items-center gap-4 text-white/60 hover:text-white px-8 py-4 group font-bold">
                            <i data-lucide="log-in" class="rotate-180"></i> <span class="font-medium">Keluar</span>
                        </button>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col">
                        <div class="h-16 flex items-center justify-end px-10 border-b border-white/5">
                            <div class="relative group mr-4">
                                <input type="text" class="bg-[#1A1A40] border border-blue-900 rounded-full py-1.5 pl-4 pr-10 text-xs w-56 outline-none" placeholder="Search Database...">
                                <i data-lucide="search" class="absolute right-3 top-2 text-blue-400 w-4 h-4"></i>
                            </div>
                            <button onclick="navigate('bio')" class="text-white/40 hover:text-white transition-colors p-1"><i data-lucide="x"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-12 custom-scrollbar">${content}</div>
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
